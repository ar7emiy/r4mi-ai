version: '3.9'

services:
  r4mi-ai:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DATABASE_URL=sqlite:///./r4mi.db
      - PATTERN_CONFIDENCE_THRESHOLD=${PATTERN_CONFIDENCE_THRESHOLD:-0.75}
      - AGENTVERSE_MATCH_THRESHOLD=${AGENTVERSE_MATCH_THRESHOLD:-0.85}
      - TRUST_PROMOTION_MIN_RUNS=${TRUST_PROMOTION_MIN_RUNS:-10}
      - TRUST_PROMOTION_MAX_FAILURE_RATE=${TRUST_PROMOTION_MAX_FAILURE_RATE:-0.05}
    volumes:
      - r4mi-db:/app/backend  # Persist SQLite DB
    restart: unless-stopped

  chatwoot:
    image: chatwoot/chatwoot:latest
    ports:
      - "3000:3000"
    environment:
      - RAILS_ENV=production
      - SECRET_KEY_BASE=changeme_in_production
      - FRONTEND_URL=http://localhost:3000
      - DATABASE_URL=postgresql://chatwoot:chatwoot@chatwoot-db:5432/chatwoot
      - REDIS_URL=redis://chatwoot-redis:6379
    depends_on:
      - chatwoot-db
      - chatwoot-redis
    restart: unless-stopped
    profiles:
      - chatwoot  # Start with: docker-compose --profile chatwoot up

  chatwoot-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=chatwoot
      - POSTGRES_USER=chatwoot
      - POSTGRES_PASSWORD=chatwoot
    volumes:
      - chatwoot-db:/var/lib/postgresql/data
    profiles:
      - chatwoot

  chatwoot-redis:
    image: redis:7-alpine
    profiles:
      - chatwoot

volumes:
  r4mi-db:
  chatwoot-db:
